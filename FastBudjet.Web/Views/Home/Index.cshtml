@model FastBudjet.Web.Models.HomeViewModel.IndexViewModel

@{
    Layout = "~/Views/Home/_Layout.cshtml";
    ViewData["RasxodCategory"] = Model.ExpenseCategories;
    ViewData["DoxodCategory"] = Model.IncomingCategories;
    ViewData["Title"] = "Обзор";
    ViewData["Header"] = "Обзор";
}

<div class="alert alert-warning alert-dismissible fade show hidden-element" id="alert_subs_expiration"
     role="alert">
    <div class="alert_txt"></div> <a href="">Возобновить</a>
    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
        <span aria-hidden="true">×</span>
    </button>
</div>

<div class="row">
    <div class="col-md-6 mt-3 mt-3  px-lg-2">
        <div id="card_ov_s_this_month" class="d-flex card_no_padding card_overview card_hover">

            <div class="my-2 px-1 w-50">
                <div class="chartjs-size-monitor">
                    <div class="chartjs-size-monitor-expand">
                        <div class=""></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink">
                        <div class=""></div>
                    </div>
                </div>
                <canvas id="overview_this_month_canvas" height="124" width="159"
                        class="chartjs-render-monitor"></canvas>
            </div>

            <div class="col d-flex flex-column pt-1 pl-0 pb-2 noselect" id="card_ov_s_this_month_click">
                <div class="mt-2 ml-1"><b>В этом месяце</b></div>

                <div class="d-flex justify-content-between mt-1">
                    <i class="material-icons income_up_icon">keyboard_arrow_up</i>
                    <div id="ov_this_month_incomes_val" class="big_text_1 text-right" style="color: rgb(76, 175, 80);">
                        71&nbsp;000,00&nbsp;UZS
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-1">
                    <i class="material-icons expense_down_icon">keyboard_arrow_down</i>
                    <div id="ov_this_month_expenses_val" class="big_text_1 text-right" style="color: rgb(244, 67, 54);">
                        -15&nbsp;099,00&nbsp;UZS
                    </div>
                </div>

                <div class="d-flex row">
                    <div class="col-5"></div>
                    <hr class="col my-1 mr-3">
                </div>

                <div class="d-flex justify-content-between">
                    <div class=""></div>
                    <div id="this_month_total_val" class="big_text_1 text-right">
                        55&nbsp;901,00&nbsp;UZS
                    </div>
                </div>
            </div>

            <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                <div class="loading_container-general">
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_1"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_2"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_3"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_4"> </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
    <div class="col-md-6 mt-3 mt-3  px-lg-2">
        <div id="card_ov_s_last_month" class="d-flex card_no_padding card_overview card_hover">

            <div class="my-2 px-1 w-50">
                <div class="chartjs-size-monitor">
                    <div class="chartjs-size-monitor-expand">
                        <div class=""></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink">
                        <div class=""></div>
                    </div>
                </div>
                <canvas id="overview_s_last_month_canvas" height="124"
                        style="display: block; width: 159px; height: 124px;" width="159"
                        class="chartjs-render-monitor"></canvas>
            </div>

            <div class="col d-flex flex-column pt-1 pl-0 pb-2 noselect" id="card_ov_s_last_month_click">
                <div class="mt-2 ml-1"><b>В прошлом месяце</b></div>

                <div class="d-flex justify-content-between mt-1">
                    <i class="material-icons income_up_icon">keyboard_arrow_up</i>
                    <div id="ov_last_month_incomes_val" class="big_text_1 text-right" style="color: rgb(76, 175, 80);">
                        69&nbsp;000,00&nbsp;UZS
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-1">
                    <i class="material-icons expense_down_icon">keyboard_arrow_down</i>
                    <div id="ov_last_month_expenses_val" class="big_text_1 text-right" style="color: rgb(244, 67, 54);">
                        -63&nbsp;695,50&nbsp;UZS
                    </div>
                </div>

                <div class="d-flex row">
                    <div class="col-5"></div>
                    <hr class="col my-1 mr-3">
                </div>

                <div class="d-flex justify-content-between">
                    <div class=""></div>
                    <div id="ov_last_month_total_val" class="big_text_1 text-right" style="color: rgb(76, 175, 80);">
                        5&nbsp;304,50&nbsp;UZS
                    </div>
                </div>
            </div>

            <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                <div class="loading_container-general">
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_1"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_2"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_3"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_4"> </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<div class="row">
    <div class="col-md-6 mt-3 mt-3  px-lg-2">
        <div id="card_ov_summary" class="d-flex flex-column card_no_padding card_overview card_hover px-3">

            <div class="noselect mt-2 pt-1"><b>Баланс</b></div>

            <div class="d-flex justify-content-between mt-1">
                <div class="big_text_1">Баланс:</div>
                <div id="summary_total_balance" class="big_text_2" style="color: @(Model.Summary.StartsWith("-") ?  "rgb(244, 67, 54);": "rgb(76, 175, 80);")">
                    @Model.Summary&nbsp;UZS
                </div>
            </div>

            <div class="d-flex justify-content-between mt-1">
                <div class="big_text_1">Кредитные карты:</div>
                @*<div id="summary_credit_cards" class="big_text_1" style="color: rgb(244, 67, 54);">
                        -1&nbsp;350,00&nbsp;UZS
                    </div>*@
            </div>


            <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                <div class="loading_container-general">
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_1"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_2"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_3"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_4"> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="col-md-6 mt-3 mt-3  px-lg-2">
        <div id="card_overview_accounts" class="position-relative card_no_padding card_overview card_hover">

            <div class="d-flex justify-content-between noselect">
                <div class="mt-2 pt-1 px-3"><b>Счета</b></div>

                <div id="overview_list_accounts_options" class="card_options_btn mt-1 mr-1">
                    <i class="material-icons">more_vert</i>
                </div>
            </div>

            <div id="overview_list_accounts" class="list-group px-3">
                @foreach (var account in Model.Accounts)
                {
                    <div class="d-flex" id="t_account_overview_container">
                        <div class="w-100">
                            <div class="d-flex justify-content-between px-1 py-2">
                                <div id="t_account_overview_name" class="big_text_2">@account.Name</div>

                                <div class="">
                                    <div id="t_account_overview_value" class="text-right"
                                         style="color: @(account.BalanceStr.StartsWith("-") ?  "rgb(244, 67, 54);": "rgb(76, 175, 80);")">
                                        @account.BalanceStr&nbsp;UZS
                                    </div>
                                    <div id="t_account_overview_currency" class="text-right">UZS - </div>
                                </div>
                            </div>

                            <hr id="t_account_overview_divider" class="divider px-3">
                        </div>
                    </div>

                }
            </div>

            <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                <div class="loading_container-general">
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_1"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_2"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_3"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_4"> </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<div class="row">
    @*<div class="col-md-6 mt-3 mb-2">
            <div id="card_overview_last_days_chart"
                 class="position-relative card_no_padding card_overview card_hover mt-3">

                <div class="d-flex justify-content-between noselect">
                    <div class="mt-2 pt-1 px-3"><b>Последние 7 дней</b></div>

                    <div id="overview_list_last_days_options" class="card_options_btn mt-1 mr-1">
                        <i class="material-icons">more_vert</i>
                    </div>
                </div>

                <div class="w-100 mt-2 mb-2 px-2">
                    <div class="chartjs-size-monitor">
                        <div class="chartjs-size-monitor-expand">
                            <div class=""></div>
                        </div>
                        <div class="chartjs-size-monitor-shrink">
                            <div class=""></div>
                        </div>
                    </div>
                    <canvas id="overview_last_days_chart" height="250" width="479" class="chartjs-render-monitor"
                            style="display: block; width: 479px; height: 250px;"></canvas>
                </div>

                <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                    <div class="loading_container-general">
                        <div class="loading_internal">
                            <div class="loading_ballcolor loading_ball_1"> </div>
                        </div>
                        <div class="loading_internal">
                            <div class="loading_ballcolor loading_ball_2"> </div>
                        </div>
                        <div class="loading_internal">
                            <div class="loading_ballcolor loading_ball_3"> </div>
                        </div>
                        <div class="loading_internal">
                            <div class="loading_ballcolor loading_ball_4"> </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>*@

    <div class="col-md-12 mt-3 mb-2">


        <div id="card_overview_balance_chart" class="position-relative card_small_body card_overview px-3">

            <div class="d-flex justify-content-between noselect">
                <div class="mt-2 pt-1"><b>Баланс</b></div>
            </div>

            <div class="w-100 mt-3 mb-3">
                <div class="chartjs-size-monitor">
                    <div class="chartjs-size-monitor-expand">
                        <div class=""></div>
                    </div>
                    <div class="chartjs-size-monitor-shrink">
                        <div class=""></div>
                    </div>
                </div>
                <canvas id="overview_balance_chart" height="250" width="463" class="chartjs-render-monitor"
                        style="display: block; width: 463px; height: 250px;"></canvas>
            </div>

            <div class="loading_background d-flex align-content-center justify-content-center align-items-center hidden-element">
                <div class="loading_container-general">
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_1"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_2"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_3"> </div>
                    </div>
                    <div class="loading_internal">
                        <div class="loading_ballcolor loading_ball_4"> </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

</div>



<button id="fab_add_tr_transfer" class="btn btn_fab btn_blue hidden-element" style="margin-right: 10px;">
    <i class="material-icons">loop</i>
</button>

<button id="fab_add_tr_income" class="btn btn_fab btn_green"
        style="margin-right: 10px; margin-bottom: 6.7rem;">
    <i class="material-icons">add</i>
</button>

<button id="fab_add_tr_expense" class="btn btn_fab btn_red" style="margin-right: 10px;">
    <i class="material-icons">remove</i>
</button>

<button id="fab_add_tr_general" class="btn btn_fab btn_blue" style="margin-right: 10px; display: none;">
    <i class="material-icons">expand_less</i>
</button>

<div id="modal_add_transaction" class="modal fade show" data-backdrop="static" role="dialog">
    <div class="modal-dialog modal-lg">
        <div id="modal_add_tr_content" class="modal-content pt-1 pb-2 px-2">
            <div class="d-flex noselect">
                <span style="width: 42px"></span>
                <p class="modal_title_big mx-auto" id="modal_add_transaction_title">
                    Новый
                    доход
                </p>
                <i class="material-icons navbar_icon float-right mt-2 mr-1" id="i_add_tr_select_template">star</i>
            </div>
            <form id="add_transaction_form" asp-controller="Operations" asp-action="Create" method="post">

                <div class="mt-1 mr-3">

                    <div class="input-group ml-2">
                        <div class="form-group wrap_strict">
                            <label asp-for="CreateViewModel.Amount">Значение</label>
                            <input required asp-for="CreateViewModel.Amount" type="number" value="" class="form-control green" min="0" step="0.01" maxlength="15">
                            <div class="invalid-feedback" id="new_tr_value_error_msg">Неверное значение</div>
                        </div>

                        <div class="input-group-append mt-2 ml-2">
                            <span class="input-group-text" id="new_tr_value_currency" style="padding-bottom: 0px;">UZS</span>
                        </div>

                        <span class="d-flex flex-grow-1 align-self-center ml-4 mr-auto">
                            <span class="input-group-text" id="new_tr_budget_amount_left"></span>
                        </span>
                    </div>


                    <div id="transaction_category_add" data-toggle="modal" data-target="#modal_item_list_prixod" class="input-group">
                        <span class="input-group-prepend">
                            <span class="input-group-text">
                                <img id="new_tr_category_icon" draggable="false" class="transaction_icon material-icons-48px align-self-center" src="/static/icons/ic_blank_grey.svg">
                            </span>
                        </span>
                        <div class="form-group wrap">
                            <label asp-for="CreateViewModel.CategoryId">Категория</label>
                            <input required asp-for="CreateViewModel.CategoryId" type="hidden" />
                            <input type="text" class="form-control cursor_pointer green is_hint" id="CreateViewModel_CategoryName" value="Выбрать категорию" readonly="">

                            <div class="invalid-feedback">Неверное значение</div>
                        </div>
                    </div>

                    <input required asp-for="CreateViewModel.Income" type="hidden" />

                    <div class="input-group" data-select2-id="24">
                        <div class="input-group-prepend">
                            <span class="input-group-text">
                                <i class="material-icons material-icons-48px align-self-center">account_balance</i>
                            </span>
                        </div>
                        <div class="form-group wrap" data-select2-id="23">
                            <label asp-for="CreateViewModel.AccountId">Счёт</label>
                            <select asp-for="CreateViewModel.AccountId" class="form-control" style="width: 100%" tabindex="-1">
                                @foreach (var account in Model.Accounts)
                                {
                                    <option value="@account.Id">@account.Name</option>
                                }
                            </select>
                            <div class="invalid-feedback">Неверное значение</div>
                        </div>

                    </div>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">
                                <i class="material-icons material-icons-48px align-self-center">today</i>
                            </span>
                        </div>
                        <div class="form-group col-5 col-md-4 px-0 mr-3">
                            <label asp-for="CreateViewModel.CreatedTime">Дата</label>
                            <input required asp-for="CreateViewModel.CreatedTime" type="text" class="form-control datepicker green" data-dtp="dtp_6hy5v">
                            <div class="invalid-feedback">Неверное значение</div>
                        </div>

                    </div>

                    <div class="input-group">
                        <div class="input-group-prepend">
                            <span class="input-group-text">
                                <i class="material-icons material-icons-48px align-self-center">mode_edit</i>
                            </span>
                        </div>
                        <div class="form-group">
                            <label asp-for="CreateViewModel.Description">Комментарии (Необязательно)</label>
                            <textarea asp-for="CreateViewModel.Description" type="text" class="form-control green" maxlength="999" rows="2"></textarea>
                            <div class="invalid-feedback">Ошибка: Значение очень длинное. Максимально 1000 символов</div>
                        </div>
                    </div>


                </div>

                <div class="d-flex justify-content-end mt-3">
                    <button type="button" id="button_add_transaction_cancel" class="btn_general mr-2 btn_green">Отменить</button>
                    <button type="submit" id="button_add_transaction_save" class="btn_general btn_green">Сохранить</button>
                    <button type="button" id="button_add_transaction_save_new" class="btn_general ml-2 btn_green">Сохранить -&gt; +</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div id="modal_card_options" class="modal fade" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content pt-1 pb-2 px-2">
            <p class="modal_title align-self-center" id="modal_card_options_title"></p>

            <div class="mt-1 mx-1">
                <div class="list-group">

                    <div class="d-flex align-items-center form-group pt-1 mx-2">
                        <span class="w-100">Количество отображаемых элементов:</span>
                        <select class="form-control ml-2" id="select_number_items_card_options">
                        </select>
                    </div>

                </div>
            </div>

            <div class="d-flex justify-content-end mt-3">
                <button type="button" id="button_card_options_cancel"
                        class="btn_general btn_blue mr-2">
                    Отменить
                </button>
                <button type="button" id="button_card_options_save" class="btn_general btn_blue">Сохранить</button>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>


        $(document).ready(function () {

            var thisMonthIncome = "@Html.Raw(Model.ThisMonthStat.Income)";
            var thisMonthExpense = "@Html.Raw(Model.ThisMonthStat.Expense)";
            var thisMonthDiff = "@Html.Raw(Model.ThisMonthStat.Diff)";

            var thisMonthLabels = [` Доходы: ${thisMonthIncome} UZS`, ` Расходы: -${thisMonthExpense} UZS`]
            var thisMonthData = [parseFloat("@Html.Raw(Model.ThisMonthStat.IncomeNum)"),
                parseFloat("@Html.Raw(Model.ThisMonthStat.ExpenseNum)")]

            var lastMonthIncome = "@Html.Raw(Model.LastMonthStat.Income)";
            var lastMonthExpense = "@Html.Raw(Model.LastMonthStat.Expense)";
            var lastMonthDiff = "@Html.Raw(Model.LastMonthStat.Diff)";

            var lastMonthLabels = [` Доходы: ${lastMonthIncome} UZS`, ` Расходы: -${lastMonthExpense} UZS`]
            var lastMonthData =  [parseFloat("@Html.Raw(Model.LastMonthStat.IncomeNum)"),
                parseFloat("@Html.Raw(Model.LastMonthStat.ExpenseNum)")]

            var monthDailtDataSets = [];
            var monthDailyLabels = [];
            var monthDailyData = [];

            var monthDailyStat = [];

            @foreach(var dailyStat in Model.MonthDailyStats)
            {
                <text>
                var dayStatSummary = parseFloat("@Html.Raw(dailyStat.Summary)");
                var dayStatSummaryStr = "@Html.Raw(dailyStat.SummaryStr)";
                var dayStatDay = "@Html.Raw(dailyStat.Day)";

                monthDailyLabels.push(dayStatDay);
                monthDailyData.push(dayStatSummary);
                monthDailyStat.push(dayStatSummaryStr);
            </text>
            }


            monthDailtDataSets.push({
                data: monthDailyData,
                label: "",
                fill: true,
                borderColor: "rgb(54, 162, 235)"
            })

            $("div#ov_this_month_incomes_val").html(`${thisMonthIncome} UZS`)
            $("div#ov_this_month_expenses_val").html(`${thisMonthExpense} UZS`)
            $("div#this_month_total_val").html(`${thisMonthDiff} UZS`)

            $("div#ov_last_month_incomes_val").html(`${lastMonthIncome} UZS`)
            $("div#ov_last_month_expenses_val").html(`${lastMonthExpense} UZS`)
            $("div#ov_last_month_total_val").html(`${lastMonthDiff} UZS`)

            if (thisMonthDiff.startsWith("-"))
                $("div#this_month_total_val").css("color", "rgb(244, 67, 54)" )
            else
                $("div#this_month_total_val").css( "color", "rgb(76, 175, 80)")


            if (lastMonthDiff.startsWith("-"))
                $("div#ov_last_month_total_val").css( "color", "rgb(244, 67, 54)")
            else
                $("div#ov_last_month_total_val").css("color", "rgb(76, 175, 80)" )



            new Chart(document.getElementById("overview_this_month_canvas"), {
                type: 'doughnut',

                data: {
                    labels: thisMonthLabels,
                    datasets: [
                        {
                        backgroundColor: ["#49BB4C", "#EA4A3E"],
                            data: thisMonthData
                        }
                    ]
                },
                options: {
                    legend: {
                        display: false,
                    },
                    plugins: {
                        labels: {
                            render: 'percentage',
                            fontSize: 14,
                            fontStyle: 'bold',
                            fontColor: ['black', 'black'],
                            precision: 2
                        },
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                return thisMonthLabels[tooltipItem.index];
                            }
                        }
                    },
                }
            });


            new Chart(document.getElementById("overview_s_last_month_canvas"), {
                type: 'doughnut',

                data: {
                    labels: lastMonthLabels,
                    datasets: [
                        {
                            backgroundColor: ["#49BB4C", "#EA4A3E"],
                            data: lastMonthData
                        }
                    ]
                },
                options: {
                    legend: {
                        display: false,
                    },
                    plugins: {
                        labels: {
                            render: 'percentage',
                            fontSize: 14,
                            fontStyle: 'bold',
                            fontColor: ['black', 'black'],
                            precision: 2
                        },
                    },
                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                return lastMonthLabels[tooltipItem.index];
                            }
                        }
                    },
                }
            });
            function commarize(min) {
                min = min || 1e3;
                var val = Math.abs(this);
                var simbl = ""
                if (this < 0)
                    simbl = "-"
                // Alter numbers larger than 1k
                if (val >= min) {

                    var units = ["k", "M", "B", "T"];

                    var order = Math.floor(Math.log(val) / Math.log(1000));

                    var unitname = units[(order - 1)];
                    var num = Math.floor(val / 1000 ** order);

                    // output number remainder + unitname
                    return simbl + num + unitname + " UZS"
                }

                // return formatted original number
                return simbl + val.toLocaleString() + " UZS"
            }
            Number.prototype.commarize = commarize
            String.prototype.commarize = commarize

            Chart.defaults.global.pointHitDetectionRadius = 1;


            new Chart(document.getElementById("overview_balance_chart"), {
                type: 'line',
                data: {
                    labels: monthDailyLabels,
                    datasets: monthDailtDataSets

                },
                options: {
                    legend: {
                        display: false,
                    },
                    responsive: true,
                    title: {
                        display: false,
                        text: 'World population per region (in millions)'
                    },

                    tooltips: {
                        callbacks: {
                            label: function (tooltipItem, data) {
                                var label = data.datasets[tooltipItem.datasetIndex].label || '';


                                if (label) {
                                    label += ': ';
                                }
                                //label += Math.round(tooltipItem.yLabel * 100) / 100;
                                return label + " " + monthDailyStat[tooltipItem.index];
                            }
                        }
                    },
                    scales: {
                        yAxes: [{
                            ticks: {
                                // Include a dollar sign in the ticks
                                callback: function (value, index, values) {
                                    return String(value).commarize();
                                }
                            },
                            scaleLabel: {
                                display: true,
                                labelString: "Сумма"
                            }
                        }],

                    }
                }
            });



        })
    </script>
}